rules_version = '2';
service cloud.firestore {
  // --- Utility Functions ---
  function isAuthenticated() {
    return request.auth != null;
  }

  function isCurrentUser(userId) {
    return isAuthenticated() && request.auth.uid == userId;
  }

  function isAdmin() {
    return isAuthenticated() && request.auth.token.get('admin', false) == true;
  }

  // ensures increment/decrement only by 1 (or unchanged) and non-negative
  function isValidCountChange(newCount, fieldName, resourceData) {
    let oldCount = resourceData.get(fieldName, 0);
    return newCount is number && newCount >= 0 && (
      newCount == oldCount + 1 ||
      newCount == oldCount - 1 ||
      newCount == oldCount
    );
  }

  // --- Artifacts Collection (fallback: read public, admin-only writes) ---
  match /databases/{database}/documents/artifacts/{appId}/{collection=**} {
    allow read: if true;
    allow create, update, delete: if isAdmin();
  }

  // --- Categories (Awards) ---
  match /databases/{database}/documents/artifacts/{appId}/categories/{categoryId} {
    allow read: if true;
    allow create, delete: if isAdmin();
    allow update: if isAdmin() || (
      isAuthenticated() &&
      request.resource.data.diff(resource.data).changedKeys().hasOnly(['totalVotes']) &&
      isValidCountChange(request.resource.data.totalVotes, 'totalVotes', resource.data)
    );
  }

  // --- Nominees (Awards) ---
  match /databases/{database}/documents/artifacts/{appId}/nominees/{nomineeId} {
    allow read: if true;
    allow create, delete: if isAdmin();

    // Allow admins OR authenticated clients to update 'votes' (increment/decrement by 1)
    allow update: if isAdmin() || (
      isAuthenticated() &&
      request.resource.data.diff(resource.data).changedKeys().hasOnly(['votes']) &&
      isValidCountChange(request.resource.data.votes, 'votes', resource.data)
    );
  }

  // --- Movies ---
  match /databases/{database}/documents/artifacts/{appId}/movies/{movieId} {
    allow read: if true;
    allow create, delete: if isAdmin();

    allow update: if isAdmin() || (
      isAuthenticated() &&
      isAuthenticated() &&
      // Removed strict hasOnly check to unblock potential hidden field issues
      // request.resource.data.diff(resource.data).changedKeys().hasOnly(
      //  ['likesCount', 'dislikesCount', 'avgRating', 'reviewCount']
      // ) &&
      (!request.resource.data.diff(resource.data).changedKeys().hasAny(['likesCount']) || isValidCountChange(request.resource.data.likesCount, 'likesCount', resource.data)) &&
      (!request.resource.data.diff(resource.data).changedKeys().hasAny(['dislikesCount']) || isValidCountChange(request.resource.data.dislikesCount, 'dislikesCount', resource.data)) &&
      (
         !request.resource.data.diff(resource.data).changedKeys().hasAny(['avgRating']) || 
         (request.resource.data.avgRating is number && request.resource.data.avgRating >= 0)
      ) &&
      (
         // Relaxed rule: Allow any non-negative integer for reviewCount (to enable recalculation)
         !request.resource.data.diff(resource.data).changedKeys().hasAny(['reviewCount']) || 
         (request.resource.data.reviewCount is number && request.resource.data.reviewCount >= 0)
      )
    );

    match /movieReactions/{userId} {
      allow read: if isCurrentUser(userId) || isAdmin();
      allow create, update: if isCurrentUser(userId) &&
                             request.resource.data.reaction in ['like', 'dislike'] &&
                             request.resource.data.timestamp is timestamp;
      allow delete: if isCurrentUser(userId) || isAdmin();
    }

    match /feedback/{userId} {
      allow read: if isCurrentUser(userId) || isAdmin();
      // Relationed condition: Allow update if the user owns it. 
      // Removed strict keys() check to avoid breaking if legacy docs have extra fields,
      // but enforcing 'type' validity.
      allow create, update: if isCurrentUser(userId) &&
                            request.resource.data.type in ['like', 'dislike', null] &&
                            ( !('timestamp' in request.resource.data) || request.resource.data.timestamp is timestamp ) &&
                            ( !('updatedAt' in request.resource.data) || request.resource.data.updatedAt is timestamp );
      allow delete: if isCurrentUser(userId) || isAdmin();
    }
  }

  // --- News ---
  match /databases/{database}/documents/artifacts/{appId}/news/{newsId} {
    allow read: if true;
    allow create, delete: if isAdmin();
    allow update: if isAdmin() || (
      // Allow views increment for everyone (including unauthenticated)
      (request.resource.data.diff(resource.data).changedKeys().hasOnly(['views']) &&
       isValidCountChange(request.resource.data.views, 'views', resource.data))
    ) || (
      // Allow likes/dislikes for authenticated users
      isAuthenticated() &&
      request.resource.data.diff(resource.data).changedKeys().hasOnly(['likesCount', 'dislikesCount']) &&
      isValidCountChange(request.resource.data.likesCount, 'likesCount', resource.data) &&
      isValidCountChange(request.resource.data.dislikesCount, 'dislikesCount', resource.data)
    );

    match /feedback/{userId} {
      allow read: if isCurrentUser(userId) || isAdmin();
      allow create, update: if isCurrentUser(userId) &&
                            request.resource.data.type in ['like', 'dislike', null];
      allow delete: if isCurrentUser(userId) || isAdmin();
    }
  }

  // --- Blogs ---
  match /databases/{database}/documents/artifacts/{appId}/blogs/{blogId} {
    allow read: if true;
    allow create, delete: if isAdmin();
    allow update: if isAdmin() || (
       // Allow views increment
       (request.resource.data.diff(resource.data).changedKeys().hasOnly(['views']) &&
        isValidCountChange(request.resource.data.views, 'views', resource.data))
    ) || (
      isAuthenticated() &&
      request.resource.data.diff(resource.data).changedKeys().hasOnly(['likesCount', 'dislikesCount']) &&
      isValidCountChange(request.resource.data.likesCount, 'likesCount', resource.data) &&
      isValidCountChange(request.resource.data.dislikesCount, 'dislikesCount', resource.data)
    );

    match /feedback/{userId} {
      allow read: if isCurrentUser(userId) || isAdmin();
      allow create, update: if isCurrentUser(userId) &&
                            request.resource.data.type in ['like', 'dislike', null];
      allow delete: if isCurrentUser(userId) || isAdmin();
    }
  }

  // --- Comments (Old Schema - Keep if needed, but adding new one) ---
  match /databases/{database}/documents/artifacts/{appId}/comments/{commentId} {
    allow read: if true;
    allow create: if isCurrentUser(request.resource.data.userId);
    allow update: if isAdmin() || (resource.data.userId == request.auth.uid) || (
      isAuthenticated() && request.resource.data.diff(resource.data).changedKeys().hasOnly(['reactions'])
    );
    allow delete: if (resource.data.userId == request.auth.uid) || isAdmin();
  }

  // --- Article Comments (New Schema used by CommentSection) ---
  match /databases/{database}/documents/artifacts/{appId}/article_comments/{commentId} {
    allow read: if true;
    allow create: if isAuthenticated() &&
                   request.resource.data.userId == request.auth.uid &&
                   request.resource.data.text is string &&
                   request.resource.data.text.size() > 0 &&
                   request.resource.data.articleId is string;
    
    // ALLOW REACTIONS:
    allow update: if isAdmin() || (resource.data.userId == request.auth.uid) || (
      isAuthenticated() && request.resource.data.diff(resource.data).changedKeys().hasOnly(['reactions'])
    );
    
    allow delete: if (resource.data.userId == request.auth.uid) || isAdmin();
  }

  // --- Reviews ---
  match /databases/{database}/documents/artifacts/{appId}/reviews/{reviewId} {
    allow read: if true;
    allow create: if isCurrentUser(request.resource.data.userId);
    // Allow author/admin update/delete OR auth users for reactions
    allow update: if isAdmin() || (resource.data.userId == request.auth.uid) || (
      isAuthenticated() && request.resource.data.diff(resource.data).changedKeys().hasOnly(['reactions'])
    );
    allow delete: if (resource.data.userId == request.auth.uid) || isAdmin();
  }

  // --- User Interests ---
  match /databases/{database}/documents/artifacts/{appId}/users/{userId}/interests/{movieId} {
    allow read, write: if isCurrentUser(userId);
  }

  // --- Polls ---
  match /databases/{database}/documents/artifacts/{appId}/polls/{pollId} {
    allow read: if true;
    allow create, update, delete: if isAdmin();

    match /votes/{userId} {
      allow read: if true;
      allow create, update: if isCurrentUser(userId) &&
                             request.resource.data.userId == userId &&
                             request.resource.data.selectedOption is string;
      allow delete: if isAdmin();
    }
  }

  // --- Other Choices ---
  match /databases/{database}/documents/artifacts/{appId}/otherChoices/{choiceId} {
    allow read: if true;
    allow create: if isAuthenticated()
                  && request.resource.data.keys().hasOnly(['categoryId','nomineeId','text','userId','createdAt'])
                  && request.resource.data.categoryId is string
                  && request.resource.data.nomineeId is string
                  && request.resource.data.text is string
                  && request.resource.data.text.size() > 0
                  && request.resource.data.text.size() <= 300
                  && request.resource.data.userId == request.auth.uid
                  && request.resource.data.createdAt is timestamp;
    allow update, delete: if isAdmin();
  }

  // --- User Votes per Category ---
  match /databases/{database}/documents/artifacts/{appId}/users/{userId}/userVotes/{categoryId} {
    allow read: if isCurrentUser(userId) || isAdmin();
    allow create: if isCurrentUser(userId)
                   && !exists(/databases/$(database)/documents/artifacts/$(appId)/users/$(userId)/userVotes/$(categoryId))
                   && request.resource.data.userId == userId
                   && request.resource.data.categoryId == categoryId;
    allow update, delete: if isAdmin();
  }
  
  // --- User Profiles ---
  match /databases/{database}/documents/artifacts/{appId}/users/{userId} {
    allow read: if true;
    allow create, update: if isCurrentUser(userId);
    allow delete: if isAdmin();
    allow list: if isAuthenticated();

    match /savedBlogs/{blogId} {
      allow read, write: if isCurrentUser(userId);
    }

    match /saved_articles/{articleId} {
      allow read, write: if isCurrentUser(userId);
    }

    match /saved_movies/{movieId} {
      allow read, write: if isCurrentUser(userId);
    }

    match /savedNews/{newsId} {
      allow read, write: if isCurrentUser(userId);
    }
    
    match /userComments/{commentId} {
      allow read, write: if isCurrentUser(userId);
    }

    match /favoritesCelebrities/{celebrityId} {
      allow read, write: if isCurrentUser(userId);
    }

    match /userReviews/{reviewId} {
      allow read, write: if isCurrentUser(userId);
    }
  }

  // --- Celebrities ---
  match /databases/{database}/documents/artifacts/{appId}/celebrities/{celebrityId} {
    allow read: if true;
    allow create, delete: if isAdmin();
    allow update: if isAdmin() || (
      isAuthenticated() &&
      request.resource.data.diff(resource.data).changedKeys().hasOnly(['favoritesCount']) &&
      isValidCountChange(request.resource.data.favoritesCount, 'favoritesCount', resource.data)
    );
  }

  // --- Feedback Form (global) ---
  match /databases/{database}/documents/{appId}/feedback/{feedbackId} {
    allow create: if isAuthenticated();
    allow read, delete: if isAdmin();
  }

  // --- Feedback (Artifacts) ---
  match /databases/{database}/documents/artifacts/{appId}/feedback/{feedbackId} {
    allow create: if true;
    allow read, delete, update: if isAdmin();
  }

  // --- Promotion Inquiries ---
  match /databases/{database}/documents/artifacts/{appId}/promotion_inquiries/{inquiryId} {
    allow create: if true;
    allow read, delete, update: if isAdmin();
  }

  // --- Notifications (Global) ---
  match /databases/{database}/documents/notifications/{notificationId} {
    allow read: if true;
    allow write: if isAdmin();
  }
  // --- Social Posts ---
  match /databases/{database}/documents/artifacts/{appId}/social_posts/{postId} {
    allow read: if true;
    allow create, delete: if isAdmin();
    allow update: if isAdmin() || (
      isAuthenticated() &&
      request.resource.data.diff(resource.data).changedKeys().hasOnly(['likes', 'likedBy', 'comments'])
    );
  }
}
